#!/bin/bash

# Get the hostname
HOSTNAME=$(hostname)

# Get the path of the current repository
REPOS_PATH=$(git rev-parse --show-toplevel)

# Extract the repository name from the repository path
REPO_NAME=$(basename $REPOS_PATH)

# Construct the log file path
LOG_FILE="/tmp/${HOSTNAME}_${REPO_NAME}.log"

echo "Git hook logs are available at: $LOG_FILE"

# Log start of the hook execution
echo "$(date): Starting hook execution" >> $LOG_FILE

# Get the latest commit hash to be pushed
LATEST_COMMIT=$(git rev-parse HEAD)

# Log the latest commit hash
echo "$(date): Latest commit hash to be pushed is $LATEST_COMMIT" >> $LOG_FILE

# capture parameters and environment variables to the log file
echo "---" >> $LOG_FILE
echo "Parameters: $@" >> $LOG_FILE
echo "---" >> $LOG_FILE
echo "Environment:" >> $LOG_FILE
env >> $LOG_FILE
echo "---" >> $LOG_FILE
echo "Set:" >> $LOG_FILE
set >> $LOG_FILE
echo "---" >> $LOG_FILE

# Get the path of the current repository
REPOS_PATH=$(git rev-parse --show-toplevel)
echo "$(date): Repository path is $REPOS_PATH" >> $LOG_FILE
echo "---" >> $LOG_FILE

# Pull the latest Docker image
echo "$(date): Pulling Docker image" >> $LOG_FILE
docker pull ghcr.io/oriolrius/readme2notion >> $LOG_FILE 2>&1

# Check if the Docker pull was successful
if [ $? -ne 0 ]; then
  echo "$(date): Docker pull failed" >> $LOG_FILE
  exit 1
fi
echo "---" >> $LOG_FILE

# Run the Docker container with the specified command
echo "$(date): Running Docker container" >> $LOG_FILE
docker run --rm --network host -v ${REPOS_PATH}:/repos ghcr.io/oriolrius/readme2notion --commit ${LATEST_COMMIT} /repos/README.md >> $LOG_FILE 2>&1

# Check if the Docker run was successful
if [ $? -ne 0 ]; then
  echo "$(date): Docker run failed" >> $LOG_FILE
  exit 1
fi
echo "---" >> $LOG_FILE

# Log end of the hook execution
echo "$(date): Hook execution finished" >> $LOG_FILE
